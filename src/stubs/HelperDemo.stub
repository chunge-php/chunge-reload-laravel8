<?php

use Illuminate\Support\Facades\Cache;
use Illuminate\Support\Facades\Log;
use App\Exceptions\ErrCode;
use App\MyClass\Jwt;
use App\MyClass\WxPay;
use App\Models;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;
use Illuminate\Support\Facades\Redis;
use Illuminate\Support\Facades\File;

/**
 * å“åº”é”™è¯¯
 * @param int $status çŠ¶æ€ç 
 * @param string $message é”™è¯¯æ¶ˆæ¯
 * @param array $attache é™„åŠ æ¶ˆæ¯
 */
function error(int $status = 1001, string $message = 'error', array $attache = [])
{
    header("Content-type:application/json;charset=utf-8");
    $res = json_encode(array('status' => $status, 'message' => $message, 'data' => (object)[], 'attache' => $attache, 'token' => session('token', '')), JSON_UNESCAPED_UNICODE);
    exit($res);
}
/**
 * æ­£å¸¸å“åº”æ¥å£
 * @param array $data æ¥å£è¿”å›æ•°æ®
 * @param string $message æ¶ˆæ¯
 * @param array $attache é™„åŠ æ•°æ®
 */
function success($data = [], string $message = 'ok', array $attache = [])
{
    header("Content-type:application/json;charset=utf-8");
    $res = json_encode(array('status' => 0, 'message' => $message, 'data' => $data, 'attache' => $attache, 'token' => session('token', '')), JSON_UNESCAPED_UNICODE);
    exit($res);
}
function errorCode()
{
    $error = new ErrCode();
    return $error;
}


/**
 * è·å–å…¬é’¥
 *
 * @param $publicKey å…¬é’¥å­—ç¬¦ä¸²
 * @return resource
 */
function getPublicKey($publicKey)
{
    $keyResource = openssl_get_publickey($publicKey);
    return $keyResource;
}

/**
 * RSAåŠ å¯†
 *
 * @param $data å¾…åŠ å¯†æ•°æ®
 * @param $publicKey å…¬é’¥
 * @return string
 */
function rsaEncrypt($data, $publicKey)
{
    $cipherText = '';
    $keySize = openssl_pkey_get_details($publicKey)['bits'];
    $maxLength = ($keySize / 8) - 11;
    $dataChunks = str_split($data, $maxLength);
    foreach ($dataChunks as $chunk) {
        $encrypted = '';
        $success = openssl_public_encrypt($chunk, $encrypted, $publicKey);
        if (!$success) {
            return '';
        }
        $cipherText .= $encrypted;
    }
    $encodedCipherText = base64_encode($cipherText);
    return $encodedCipherText;
}
/**
 * RSAè§£å¯†
 *
 * @param string $data å¾…è§£å¯†æ•°æ®
 * @param string $privateKey ç§é’¥
 * @return string
 */
function rsaDecrypt($data, $privateKey)
{
    $privateKey = openssl_pkey_get_private($privateKey);
    $dataBytes = base64_decode($data);
    $decryptedData = '';
    $len = strlen($dataBytes);
    $offset = 0;
    $i = 0;
    $maxDecryptBlock = 128;
    $cipher = '';
    while ($len - $offset > 0) {
        if ($len - $offset > $maxDecryptBlock) {
            $cache = substr($dataBytes, $offset, $maxDecryptBlock);
            openssl_private_decrypt($cache, $cipher, $privateKey);
        } else {
            $cache = substr($dataBytes, $offset);
            openssl_private_decrypt($cache, $cipher, $privateKey);
        }
        $decryptedData .= $cipher;
        $i++;
        $offset = $i * $maxDecryptBlock;
    }
    return $decryptedData;
}

function getSignatureContent($params)
{
    ksort($params);
    $content = '';
    $index = 0;
    foreach ($params as $key => $value) {
        if (!empty($value)) {
            $content .= ($index == 0 ? '' : '&') . $key . '=' . $value;
            $index++;
        }
    }
    return $content;
}

function encryptNumber($number)
{
    $encoded = base64_encode($number);
    $encoded = str_replace('=', '', $encoded);
    return $encoded;
}

function decryptNumber($encoded)
{
    $length = strlen($encoded) % 4;
    if ($length !== 0) {
        $encoded .= str_repeat('=', 4 - $length);
    }
    $decoded = base64_decode($encoded);
    return $decoded;
}
/**
 * è·å–ç§é’¥
 *
 * @param string $privateKey ç§é’¥å­—ç¬¦ä¸²
 * @return resource
 */
function getPrivateKey($privateKey)
{
    $key = openssl_pkey_get_private($privateKey);
    if (!$key) {
        return '';
    }
    return $key;
}

/**
 * sha1WithRsaç­¾å
 *
 * @param string $data å¾…ç­¾åæ•°æ®
 * @param string $privateKey ç§é’¥
 * @return string ç­¾å
 */
function sha1Sign($data, $privateKey)
{
    $signature = openssl_get_privatekey($privateKey);
    openssl_sign($data, $signatureResult, $signature, OPENSSL_ALGO_SHA1);
    openssl_free_key($signature);
    return base64_encode($signatureResult);
}
//åŠ å¯†AES/CBC/NoPadding 
function AesOpensslEncrypt($json_data, $key, $iv)
{
    $biz_content = openssl_encrypt($json_data, 'aes-128-cbc', $key, OPENSSL_RAW_DATA, $iv);
    return rtrim(base64_encode($biz_content), "\0");
}
function AesOpensslDecrypt($json_data, $key, $iv)
{
    $biz_content = openssl_decrypt($json_data, 'aes-128-cbc', $key, OPENSSL_ZERO_PADDING, $iv);
    return $biz_content;
}

function encryptCBCNoPadding($secretKeyBytes, $intVectorBytes, $input)
{
    $ALGORITHM = "AES";
    $AES_CBC_NOPADDING = "AES/CBC/NoPadding";
    $iv = $intVectorBytes;
    $secretKey = $secretKeyBytes;
    $inputLength = strlen($input);
    $srcLength = '';

    $cipher = openssl_cipher_iv_length($ALGORITHM . '/' . $AES_CBC_NOPADDING);
    $blockSize = $cipher;
    $srcBytes = '';
    if (0 != $inputLength % $blockSize) {
        $srcLength = $inputLength + ($blockSize - $inputLength % $blockSize);
        $srcBytes = array_pad($input, $srcLength, 0);
    } else {
        $srcBytes = $input;
    }

    $encryptBytes = openssl_encrypt($srcBytes, $AES_CBC_NOPADDING, $secretKey, OPENSSL_RAW_DATA, $iv);
    return $encryptBytes;
}
//ç§é’¥åŠ å¯†
function encryptByPrivateKey($sign, $privateKey)
{
    try {
        $origiSignPublicKeyEncrypt = openssl_private_encrypt($sign, $encrypted, $privateKey);
        return rtrim(base64_encode($encrypted), "\0");
    } catch (\Exception $e) {
        return $e->getMessage();
    }
}
function getString($param)
{
    $paramStr = "";

    $paramSort = array();
    foreach ($param as $key => $value) {
        $paramSort[$key] = $value;
    }
    ksort($paramSort);

    foreach ($paramSort as $key => $value) {
        $paramStr .= "&" . $key . "=" . $value;
    }

    if (strlen($paramStr) > 0) {
        $paramStr = substr($paramStr, 1);
    }

    return $paramStr;
}
//å…±é’¥åŠ å¯†
function encryptByPublicKey($key, $publicKey)
{
    try {
        openssl_public_encrypt($key, $encrypted, $publicKey);
        return rtrim(base64_encode($encrypted), "\0");
    } catch (Exception $e) {
        return $e->getMessage();
    }
}
function ToUrlParams($values)
{
    $buff = "";
    foreach ($values as $k => $v) {
        if ($k != "sign" && $v != "" && !is_array($v)) {
            $buff .= $k . "=" . $v . "&";
        }
    }

    $buff = trim($buff, "&");
    return $buff;
}

function createKey()
{
    // ç”Ÿæˆ 2048 ä½çš„ RSA å¯†é’¥å¯¹
    $key = openssl_pkey_new(array(
        'private_key_bits' => 1024,
        'private_key_type' => OPENSSL_KEYTYPE_RSA,
    ));
    // è·å–ç§é’¥
    openssl_pkey_export($key, $privateKey);
    // è·å–å…¬é’¥
    $sympublicKey = openssl_pkey_get_details($key)['key'];
    File::put(base_path('public/paipai.private.key.pem'), $privateKey);
    File::put(base_path('public/paipai.public.key.pem'), $sympublicKey);
}
//----------------------------------------ç¼“å­˜ç›¸å…³------------------------------------

/**
 * æ¸…é™¤å…¨éƒ¨ç¼“å­˜
 */
function clearAllCache()
{
    Cache::flush();
}
/**
 * æ¸…é™¤æŒ‡å®šç¼“å­˜æˆ–æ‰€æœ‰ç¼“å­˜
 */
function cacheDelete($key = '')
{
    if (!empty($key)) {
        Cache::forget($key);
    } else {
        Cache::flush();
    }
}

/**
 * è·å–æ ‡è¯†ç¼“å­˜
 */
function getUpdateSign($uid = 0, $role_id = 0)
{
    //è‡ªå·±å·²æœ‰çš„éªŒè¯æ ‡è¯†
    // Cache::remember('sign_arr' . $uid, getCacheTime(10), function () use ($role_id) {
    //     $model = new Role();
    //     $list  =  $model->signArrRole($role_id);
    //     return $list;
    // });
    // //æ‹‰å–éœ€è¦éªŒè¯çš„æ¥å£
    // Cache::remember('menu_arr' . $uid, getCacheTime(10), function () {
    //     $menuModel = new Menu();
    //     return $menuModel->allNoFiltration();
    // });
}





//-----------------------------------------è½¬æ¢ç›¸å…³------------------------------------

/**
 * è½¬ä¸ºæ•´æ•°
 * @param string|int $num
 * @return int
 */
function toNum($num): int
{
    if ($num > 0) {
        return sprintf("%.2f", $num * 100);
    } else {
        return 0;
    }
}


/**
 * å¯è¯»åŒ–æ•°å­—
 * @param string|int $num
 * @return string
 */
function humanNum($num): string
{
    if ($num > 0) {
        return number_format($num / 100, 2, '.', '');
    } else {
        return 0;
    }
}

/**
 * å¯è¯»åŒ–æ•°å­—
 * @param string|int $num
 * @return string
 */
function humanNumInt($num): string
{
    if ($num > 0) {
        return $num / 100;
    } else {
        return 0;
    }
}
// ------------------------------------------æ•°ç»„å¤„ç†ç›¸å…³-----------------------------------

/**
 * å°†å¯¹è±¡é‡Œé¢çš„å¯¹è±¡è½¬æˆåŒçº§
 * @param array $data è¦è½¬åŒ–çš„æ•°æ®
 * @param array $key  åœ¨æ²¡æœ‰æ•°æ®çš„æƒ…å†µä¸‹é»˜è®¤çš„å€¼
 */
function formArrayData($data, $key = false)
{
    if (!$data || $data == null || count($data) < 1) {
        return $data;
    }
    if ($data && is_array($data) && !isset($data[0])) {
        $list = array();
        foreach ($data as $k => $v) {
            if (is_array($v) && count($v) == count($v, 1) && $key && isset($key[$k])) {
                foreach ($v as $ks => $vs) {
                    if ($vs == null || $vs == NULL) {
                        $vs = '';
                    }
                    $list[$k . '_' . $ks] = $vs;
                }
            } else {
                if ($key && isset($key[$k])) {
                    foreach ($key[$k] as $ks => $vs) {
                        $list[$k . '_' . $ks] = $vs;
                    }
                } else {
                    $list[$k] = $v;
                }
            }
        }
    } else {
        if (count($data) > 0) {
            $list = array();
            foreach ($data as $k => $v) {
                $new_list = array();
                foreach ($v as $ks => $vs) {
                    if (is_array($vs) && count($vs) == count($vs, 1) && $key && isset($key[$ks])) {
                        foreach ($vs as $kss => $vss) {
                            if ($vss == null || $vss == NULL) {
                                $vss = '';
                            }
                            $new_list[$ks . '_' . $kss] = $vss;
                        }
                    } else {
                        if ($key && isset($key[$ks])) {
                            foreach ($key[$ks] as $kss => $vss) {
                                $new_list[$ks . '_' . $kss] = $vss;
                            }
                        } else {
                            $new_list[$ks] = $vs;
                        }
                    }
                }
                $list[$k] = $new_list;
            }
        }
    }

    return $list;
}
/**
 * è·å–äºŒç»´æ•°ç»„æŒ‡å®šå­—æ®µé‡Œé¢çš„æœ€å°å€¼
 */
function minVal($data = [], $key = 'pid')
{
    $min_val = min(array_column($data, $key));
    return $min_val;
}

/**
 * åˆ†æ”¯æ ‘æ˜¾ç¤ºæ— é™åˆ†ç±»
 * @param $arr éœ€è¦å¤„ç†çš„æ•°ç»„
 * @param $key ç›¸å½“äºæ•°ç»„å•å…ƒçš„id
 * @param $fkey ç›¸å½“äºæ•°ç»„å•å…ƒçš„çˆ¶ç±»id
 * @param $num ä»ç¬¬å‡ å±‚æŸ¥èµ·ï¼Œä¹Ÿå°±æ˜¯è¦æŸ¥å±‚çš„çˆ¶ç±»id
 * @return $list è¿”å›çš„æ•°ç»„
 */
function recursionTree($arr, $key, $fkey, $num): array
{
    $list = array();
    foreach ($arr as $val) {
        if ($val[$fkey] == $num) {
            $tmp = recursionTree($arr, $key, $fkey, $val[$key]);
            if ($tmp) {
                $val['children'] = $tmp;
            } else {
                $val['children'] = [];
            }
            $list[] = $val;
        }
    }
    return $list;
}
function dayDateTimeForm()
{
    return date('YmdHis', time());
}
/**
 * å–å‡ºæ— çº¿åˆ†ç±»id
 */
function allChildren($data, &$item)
{
    if (count($data) > 0) {
        foreach ($data as  $v) {
            if (count($v['all_children']) > 0) {
                array_push($item, $v['id']);
                allChildren($v['all_children'], $item);
            } else {
                array_push($item, $v['id']);
            }
        }
    }
}
/**
 * ä¸Šçº§åç§°æ‹¼æ¥
 */
function nameChildren($list, $name = 'name', $all_pid = 'all_pid', $id = 'id', $str = '>', $exp = ','): array
{
    if ($list) {
        $name_arr = array_column($list, null, $id);
        foreach ($list as $k => $v) {
            $str_name = '';
            if (!empty($v[$all_pid]) && $v[$all_pid] != 0) {
                $arr = explode($exp, $v[$all_pid]);
                foreach ($arr as $ks => $vs) {
                    if (isset($name_arr[$vs])) {
                        $str_name .= $name_arr[$vs][$name] . $str;
                    }
                }
            }
            $list[$k][$name] =  $str_name . $v[$name];
        }
        return $list;
    } else {
        return array();
    }
}
/**
 * äºŒç»´æ•°ç»„æ ¹æ®æŸä¸ªå­—æ®µæ’åº
 * @param array $array è¦æ’åºçš„æ•°ç»„
 * @param string $keys   è¦æ’åºçš„é”®å­—æ®µ
 * @param string $sort  æ’åºç±»å‹  SORT_ASC     SORT_DESC
 * @return array æ’åºåçš„æ•°ç»„
 */
function arraySort($array, $keys, $sort = SORT_DESC): array
{
    $keysValue = [];
    foreach ($array as $k => $v) {
        $keysValue[$k] = $v[$keys];
    }
    array_multisort($keysValue, $sort, $array);
    return $array;
}

//--------------------------------------------éªŒè¯ç›¸å…³-------------------------------------


/**
 * å›è°ƒç»“æŸæ¨¡æ¿
 * @param  $msg string
 */
function callbackView($msg = '')
{
    //è¿”å›ç»“æœé˜²æ­¢å¾®ä¿¡é‡å¤æˆ–å¤šæ¬¡è¯·æ±‚
    $str = '<xml><return_code><![CDATA[SUCCESS]]></return_code><return_msg><![CDATA[OK]]></return_msg></xml>';
    echo $str;
    die;
}
/**
 * @param string $phone æ‰‹æœºå·
 * @return int 1ä¸­å›½ç§»åŠ¨ï¼Œ2ä¸­å›½è”é€š 3ä¸­å›½ç”µä¿¡ 0æœªçŸ¥
 */
function phoneCheck($phone = ''): int
{
    if (!empty($phone)) {
        $isChinaMobile = "/^134[0-8]\d{7}$|^(?:13[5-9]|147|15[0-27-9]|178|18[2-478])\d{8}$/"; //ç§»åŠ¨æ–¹é¢æœ€æ–°ç­”å¤
        $isChinaUnion = "/^(?:13[0-2]|145|15[56]|176|18[56])\d{8}$/"; //å‘è”é€šå¾®åšç¡®è®¤å¹¶æœªå›å¤
        $isChinaTelcom = "/^(?:133|153|177|173|191|199|18[019])\d{8}$/"; //1349å·æ®µ ç”µä¿¡æ–¹é¢æ²¡ç»™å‡ºç­”å¤ï¼Œè§†ä½œä¸å­˜åœ¨
        // $isOtherTelphone = "/^170([059])\\d{7}$/";//å…¶ä»–è¿è¥å•†
        if (preg_match($isChinaMobile, $phone)) {
            return 1; //1ä¸­å›½ç§»åŠ¨
        } else if (preg_match($isChinaUnion, $phone)) {
            return 2; //ä¸­å›½è”é€š
        } else if (preg_match($isChinaTelcom, $phone)) {
            return 3; //ä¸­å›½ç”µä¿¡
        }
    }
    return 0; //0æœªçŸ¥
}

/**éªŒè¯å¯†ç æ˜¯å¦ä¸€è‡´
 * $new_pwd åŸå¯†ç 
 * $up_pwd æ–°å¯†ç 
 */
function verifyPwd($new_pwd = '', $up_pwd = '')
{
    $new_pwd =  getPwd($new_pwd);
    $up_pwd =  getPwd($up_pwd);
    if ($new_pwd == $up_pwd) {
        return true;
    } else {
        return false;
    }
}

function jwtEnCode($data = array(), $key = 'app.admin_key')
{
    $jwt = new Jwt(config($key));
    $data['iat'] =  time();
    $data['exp'] = getTimeAdd(isset($data['exp']) ? $data['exp'] : 1);
    $token = $jwt::getToken($data);
    return $token;
}
function jwtDeCode($token = '', $key = 'app.admin_key')
{
    $jwt = new Jwt(config($key));
    $viif = $jwt::verifyToken($token);
    if ($viif) {
        $viif['iat'] = date('Y-m-d H:i:s', $viif['iat']);
        $viif['exp'] = date('Y-m-d H:i:s', $viif['exp']);
        return $viif;
    } else {
        return array();
    }
}

function createFile($contents = '')
{
    $ip       = gethostbyname(gethostname());
    $contents = str_replace('{{ip}}', $ip, $contents);
    $fd       = fopen(base_path('.encode'), 'w+');
    fwrite($fd, $contents);
    fclose($fd);
}
function getCodeVerify()
{
    $is_file =  file_exists(base_path('.encode'));
    if (!$is_file) {
        createFile();
    }
    $list = file(base_path('.encode'));
    $data = array('message' => '', 'code' => '');
    foreach ($list as $k => $v) {
        if (!empty($v)) {
            $decode = explode(';', $v);
            if (isset($decode[1])) {
                foreach ($decode as $vs) {
                    $decodes = explode('=>', $vs);
                    if (isset($decodes[1])) {
                        $key =   str_replace(' ', '', $decodes[0]);
                        $value =   str_replace(' ', '', $decodes[1]);
                        $data[$key] = $value;
                    }
                }
            }
        }
    }
    return $data;
}

function codeAnalysis()
{
    $data = getCodeVerify();
    if (empty($data['code'])) {
        error(errorCode()::ALREADY_EXISTS_NO, decrypt(config('app.admin_message')));
    }
    $jwt = new Jwt(config('app.admin_key'));
    $viif = $jwt::verifyToken($data['code']);
    if (!$viif) {
        $err  = $jwt::verifyToken($data['message']);
        if ($err) {
            error(errorCode()::ALREADY_EXISTS_NO, $err['message']);
        } else {
            error(errorCode()::ALREADY_EXISTS_NO, decrypt(config('app.admin_message')));
        }
    } else {
        return $viif;
    }
}

/**éªŒè¯æ˜¯å¦å­˜åœ¨  */
function verifyExists($model, $key = '', $where = 0)
{
    if (!is_array($where)) {
        $where = [$where];
    }
    if (empty($key) || $where == 0) {
        return false;
    }
    $res =  $model->whereIn($key, $where)->exists();
    if ($res) {
        error(errorCode()::DATA_YES, __('api.data_yes'));
    }
    return false;
}

/**
 * æƒé™éªŒè¯
 */
function verifyPermissions($uid = 0, $role_id = 0, $route_name = ''): bool
{
    $menu_arr = Cache::get('menu_arr' . $uid, false);
    $sign_arr = Cache::get('sign_arr' . $uid, false);
    if ($sign_arr == ['*']) {
        return true;
    }

    if ($menu_arr && $sign_arr) {
        if (in_array($route_name, $menu_arr)) {
            if (in_array($route_name, $sign_arr)) {
                return true;
            } else {
                return false;
            }
        } else {
            return true;
        }
    } else {
        getUpdateSign($uid, $role_id);
        $menu_arr = Cache::get('menu_arr' . $uid, false);
        $sign_arr = Cache::get('sign_arr' . $uid, false);
        if ($sign_arr == ['*']) {
            return true;
        }
        if ($menu_arr && $sign_arr) {
            if (in_array($route_name, $menu_arr)) {
                if (in_array($route_name, $sign_arr)) {
                    return true;
                } else {
                    return false;
                }
            } else {
                return true;
            }
        } else {
            return false;
        }
    }
}

/**
 * éªŒè¯æ˜¯å¦å­˜åœ¨
 * @param $model object
 * @param $where array
 */
function verifyRepetition($model, $where, $str = '', $trashed = false, $message = false)
{
    $res =  $model->when($trashed, function ($query) {
        return $query->withTrashed();
    })->where($where)->exists();
    if ($res) {
        $message = empty($message) ? __('api.repetition_sign') : $message;
        error(errorCode()::SIGN_RES, $str ??  $message);
    }
}


/**
 * å¯†ç éªŒè¯
 */
function pwdVerify($pwd, $new_pwd): bool
{
    if ($pwd == $new_pwd) {
        return true;
    } else {
        return false;
    }
}
/**
 * å¯†ç è½¬æ¢
 */
function pwdEncrypt($pwd): string
{
    $pwds = md5($pwd . 'chest');
    return $pwds;
}



//------------------------------------------------èº«ä»½è¯ç›¸å…³å¤„ç†------------------------------------
/*
* æ ¹æ®èº«ä»½è¯å·ç è·å–å¹´é¾„
* inupt   $code = å®Œæ•´çš„èº«ä»½è¯å·
* return  $age : å¹´é¾„ ä¸‰ä½æ•° å¦‚023
*/
function ageVerification($code = '')
{
    $age_time = strtotime(substr($code, 6, 8));
    if ($age_time === false) {
        return false;
    }
    list($y1, $m1, $d1) = explode("-", date("Y-m-d", $age_time));

    $now_time = strtotime("now");

    list($y2, $m2, $d2) = explode("-", date("Y-m-d", $now_time));
    $age = $y2 - $y1;
    if ((int)($m2 . $d2) < (int)($m1 . $d1)) {
        $age -= 1;
    }
    return $age;
}
/**
 * æ›´æ®èº«ä»½è¯è·å–æ€§åˆ«1ç”·2å¥³
 */
function getSex($cid = ''): int
{
    //æ ¹æ®èº«ä»½è¯å·è¿”å›æ€§åˆ«
    if (!checkIdCard($cid)) {
        return 0;
    }
    $sexint = (int) substr($cid, 16, 1);

    return 0 === $sexint % 2 ? 2 : 1;
}
/**
 * æ ¹æ®èº«ä»½è¯å·ï¼Œè‡ªåŠ¨è¿”å›å¯¹åº”çš„æ˜Ÿåº§
 */
function getXingZuo($cid = '')
{
    // æ ¹æ®èº«ä»½è¯å·ï¼Œè‡ªåŠ¨è¿”å›å¯¹åº”çš„æ˜Ÿåº§
    if (!checkIdCard($cid)) {
        return 0;
    }
    $bir = substr($cid, 10, 4);
    $month = (int) substr($bir, 0, 2);
    $day = (int) substr($bir, 2);
    $strValue = '';
    if ((1 == $month && $day <= 21) || (2 == $month && $day <= 19)) {
        $strValue = 0; //æ°´ç“¶åº§
    } elseif ((2 == $month && $day > 20) || (3 == $month && $day <= 20)) {
        $strValue = 1; //åŒé±¼åº§
    } elseif ((3 == $month && $day > 20) || (4 == $month && $day <= 20)) {
        $strValue = 2; //ç™½ç¾Šåº§
    } elseif ((4 == $month && $day > 20) || (5 == $month && $day <= 21)) {
        $strValue = 3; //é‡‘ç‰›åº§
    } elseif ((5 == $month && $day > 21) || (6 == $month && $day <= 21)) {
        $strValue = 4; //åŒå­åº§
    } elseif ((6 == $month && $day > 21) || (7 == $month && $day <= 22)) {
        $strValue = 5; //å·¨èŸ¹åº§
    } elseif ((7 == $month && $day > 22) || (8 == $month && $day <= 23)) {
        $strValue = 6; //ç‹®å­åº§
    } elseif ((8 == $month && $day > 23) || (9 == $month && $day <= 23)) {
        $strValue = 7; //å¤„å¥³åº§
    } elseif ((9 == $month && $day > 23) || (10 == $month && $day <= 23)) {
        $strValue = 8; //å¤©ç§¤åº§
    } elseif ((10 == $month && $day > 23) || (11 == $month && $day <= 22)) {
        $strValue = 9; //å¤©èåº§
    } elseif ((11 == $month && $day > 22) || (12 == $month && $day <= 21)) {
        $strValue = 10; //å°„æ‰‹åº§
    } elseif ((12 == $month && $day > 21) || (1 == $month && $day <= 20)) {
        $strValue = 11; //é­”ç¾¯åº§
    }

    return $strValue;
}
/**
 * æ ¹æ®èº«ä»½è¯å·è¿”å›å¯¹åº”çš„ç”Ÿè‚–
 */
function getShengXiao($cid = ''): int
{

    if (!checkIdCard($cid)) {
        return 0;
    }
    $start = 1901;
    $end = $end = (int) substr($cid, 6, 4);
    $x = ($start - $end) % 12;
    $value = '';
    if (1 == $x || -11 == $x) {
        $value = 0; //é¼ 
    }
    if (0 == $x) {
        $value = 1; //ç‰›
    }
    if (11 == $x || -1 == $x) {
        $value = 2; //è™
    }
    if (10 == $x || -2 == $x) {
        $value = 3; //å…”
    }
    if (9 == $x || -3 == $x) {
        $value = 4; //é¾™
    }
    if (8 == $x || -4 == $x) {
        $value = 5; //è›‡
    }
    if (7 == $x || -5 == $x) {
        $value = 6; //é©¬
    }
    if (6 == $x || -6 == $x) {
        $value = 7; //ç¾Š
    }
    if (5 == $x || -7 == $x) {
        $value = 8; //çŒ´
    }
    if (4 == $x || -8 == $x) {
        $value = 9; //é¸¡
    }
    if (3 == $x || -9 == $x) {
        $value = 10; //ç‹—
    }
    if (2 == $x || -10 == $x) {
        $value = 11; //çŒª
    }

    return $value;
}
/**
 * èº«ä»½è¯æ ¡éªŒæ˜¯å¦åˆæ³•
 *
 * @param string $idcard å®Œæ•´çš„èº«ä»½è¯å·
 */
function checkIdCard($idcard = '')
{
    // åªèƒ½æ˜¯18ä½
    if (strlen($idcard) != 18) {
        return false;
    }
    // å–å‡ºæœ¬ä½“ç 
    $idcard_base = substr($idcard, 0, 17);
    // å–å‡ºæ ¡éªŒç 
    $verify_code = substr($idcard, 17, 1);
    // åŠ æƒå› å­
    $factor = array(7, 9, 10, 5, 8, 4, 2, 1, 6, 3, 7, 9, 10, 5, 8, 4, 2);
    // æ ¡éªŒç å¯¹åº”å€¼
    $verify_code_list = array('1', '0', 'X', '9', '8', '7', '6', '5', '4', '3', '2');
    // æ ¹æ®å‰17ä½è®¡ç®—æ ¡éªŒç 
    $total = 0;
    for ($i = 0; $i < 17; $i++) {
        $total += substr($idcard_base, $i, 1) * $factor[$i];
    }
    // å–æ¨¡
    $mod = $total % 11;
    // æ¯”è¾ƒæ ¡éªŒç 
    if ($verify_code == $verify_code_list[$mod]) {
        // å¦‚æœå¹´é¾„è®¡ç®—å¤±è´¥ï¼Œåˆ™åˆ¤æ–­ä¸º èº«ä»½è¯å·æœ‰è¯¯
        if (ageVerification($idcard)) {
            return true;
        }
    }
    return false;
}
//------------------------------------------------å¾®ä¿¡ç›¸å…³------------------------------------

/**
 * å¾®ä¿¡å…¬ä¼—å·æ¶ˆæ¯æ¨é€
 */
function wxMessage($info, $type = -1)
{
    $url = 'https://api.weixin.qq.com/cgi-bin/message/template/send?access_token=' . getAccessToken(1);
    switch ($type) {
        case 0:
            //ä¸‹å•æˆåŠŸé€šçŸ¥
            $data = array(
                "touser" => (string)$info['openid'],
                "template_id" => "XXo7Jacr60FaURF8UH4FwLq9hQOinYb4hSQ1obeuYPs",
                "url" => "http://niunai.pychunge.cn/payorder.html",
                "data" => array(
                    "first" => array(
                        "value" => "å°Šæ•¬çš„ã€" . $info['name'] . "ã€‘ä½ å·²ä¸‹å•æˆåŠŸ,å°†æ ¹æ®æŠ•é€’æ—¥æœŸæ—¶é—´å¼€å§‹é…é€",
                        "color" => "#173177"
                    ),
                    "keyword1" => array(
                        "value" => "ä¼Šå¥¶é…ç‰›å¥¶",
                        "color" => "#173177"
                    ),
                    "keyword2" => array(
                        "value" => $info['number'] . "KG",
                        "color" => "#173177"
                    ),
                    "keyword3" => array(
                        "value" => (string) $info['date_time'],
                        "color" => "#173177"
                    ),
                    "keyword4" => array(
                        "value" => dayDateTime(),
                        "color" => "#173177"
                    ),
                    "remark" => array(
                        "value" => "æ„Ÿè°¢ä½ çš„ä½¿ç”¨,ç‚¹å‡»æˆ‘æŸ¥çœ‹é…é€è®¡åˆ’ã€‚å¦‚æœ‰ç–‘é—®ï¼Œè¯·è”ç³»å®¢æœ:147-9992-2633",
                        "color" => "#173177"
                    ),
                ),
            );
            break;
        case 1:
            //é€è¾¾é€šçŸ¥
            $data = array(
                "touser" => $info['openid'],
                "template_id" => "VjjW-bw-4Qf6xGX9xY7Y-XXSRFI-hc2DMmwN3rmnsuo",
                "url" => "http://niunai.pychunge.cn/payorder.html",
                "data" => array(
                    "first" => array(
                        "value" => "å°Šæ•¬çš„ã€" . $info['name'] . "ã€‘æ‚¨é¢„å®šçš„ç‰›å¥¶å·²é€è¾¾,è¯·å°½å¿«å‰æ¥é¢†å–",
                        "color" => "#173177"
                    ),
                    "keyword1" => array(
                        "value" => "ä¼Šå¥¶é…ç‰›å¥¶",
                        "color" => "#173177"
                    ),
                    "keyword2" => array(
                        "value" => $info['number'] . "KG",
                        "color" => "#173177"
                    ),
                    "keyword3" => array(
                        "value" => $info['address'],
                        "color" => "#173177"
                    ),
                    "keyword4" => array(
                        "value" => dayDateTime(),
                        "color" => "#173177"
                    ),
                    "keyword5" => array(
                        "value" => $info['staff_name'],
                        "color" => "#173177"
                    ),
                    "remark" => array(
                        "value" => "æ„Ÿè°¢æ‚¨çš„å…³æ³¨,ç¥æ‚¨ç”Ÿæ´»æ„‰å¿«ã€‚å¦‚æœ‰ç–‘é—®,å’¨è¯¢ç”µè¯:147-9992-2633",
                        "color" => "#173177"
                    ),
                ),
            );
            break;
        case 2:
            //é€è¾¾é€šçŸ¥
            $data = array(
                "touser" => $info['openid'],
                "template_id" => "uheSGIpmBr-diGUzU-y-gh4_wnD_RIrQoR4f6-v1jzg",
                "url" => "http://niunai.pychunge.cn/payorder.html",
                "data" => array(
                    "first" => array(
                        "value" => "ç‰›å¥¶è®¢è´­æé†’ï¼",
                        "color" => "#173177"
                    ),
                    "keyword1" => array(
                        "value" => 'æ— ',
                        "color" => "#173177"
                    ),
                    "keyword2" => array(
                        "value" => "å½“æ—¥åŒ—äº¬æ—¶é—´(10)ç‚¹å‰ä¸‹å•å½“å¤©é€è¾¾\nè¶…è¿‡æ—©ä¸Š10ç‚¹æ˜æ—¥é€è¾¾",
                        "color" => "#173177"
                    ),
                    "remark" => array(
                        "value" => "æ„Ÿè°¢æ‚¨çš„å…³æ³¨,ç¥æ‚¨ç”Ÿæ´»æ„‰å¿«ã€‚å¦‚æœ‰ç–‘é—®\nå’¨è¯¢ç”µè¯:147-9992-2633\nç‚¹å‡»ä¸‹æ–¹æŸ¥çœ‹è¯¦æƒ…è®¢è´­ç‰›å¥¶",
                        "color" => "#173177"
                    ),
                ),
            );
            break;
        default:
            return false;
    }
    $res = http($url, $data);
    return $res;
}
function getWxConfig($url)
{
    $pay = new WxPay();
    return $pay->getWxPayConfig($url);
}


/**
 * è§£å¯†å¾®ä¿¡æ‰‹æœºå·  è¿”å›æ‰‹æœºå·
 * @param string $appid  appid
 * @param  string  $session_key
 * @param  string $encryptedData
 * @param  string $iv
 * */
function getWxTel($appid, $session_key, $encryptedData, $iv)
{
    if (strlen($session_key) != 24) {
        error(errorCode()::ERROR, 'encodingAesKey éæ³•');
    }
    $aesKey = base64_decode($session_key);
    if (strlen($iv) != 24) {
        error(errorCode()::ERROR, 'IVé”™è¯¯');
    }
    $aesIV = base64_decode($iv);
    $aesCipher = base64_decode($encryptedData);
    $result = openssl_decrypt($aesCipher, "AES-128-CBC", $aesKey, 1, $aesIV);

    $dataObj = json_decode($result);
    if ($dataObj  == NULL) {
        error(errorCode()::ERROR, 'aes è§£å¯†å¤±è´¥');
    }
    if ($dataObj->watermark->appid != $appid) {
        error(errorCode()::ERROR, 'aes è§£å¯†å¤±è´¥');
    }
    $data = $result;
    $tel = json_decode($data, true);
    return $tel;
}
/**
 * å°ç¨‹åºæ°¸ä¹…äºŒç»´ç å¸¦å‚æ•°
 */
function createQRCode($scene = 'uuid=0', $check_path = true, $page = 'pages/index/index', $width = 430, $autoColor = false, $lineColor = [], $isHyaline = false)
{
    $url = 'https://api.weixin.qq.com/wxa/getwxacodeunlimit?access_token=' . getAccessToken();
    $lineColor = $lineColor ?? ["r" => "0", "g" => "0", "b" => "0"]; //è®¾ç½®é¢œè‰²
    $params = [
        'scene' => $scene,
        'page' => $page,
        'width' => intval($width),
        'auto_color' => $autoColor,
        'is_hyaline' => $isHyaline,
        'check_path' => $check_path
    ];

    $result = http($url, json_encode($params));
    // åˆ¤æ–­æ˜¯å¦æ˜¯ jsonæ ¼å¼ï¼Œ å¦‚æœè¯·æ±‚å¤±è´¥ï¼Œä¼šè¿”å› JSON æ ¼å¼çš„æ•°æ®ã€‚
    if (is_null(json_decode($result))) {
        /**
         * ä¸æ˜¯jsonæ ¼å¼çš„æ•°æ®   è¯´æ˜æœ‰æ•°æ®æµ  json_decode($result)è¿”å›å€¼æ˜¯ä¸º null
         * è¿™é‡Œè¿”å›çš„å›¾ç‰‡ Buffer
         */
        return ['errcode' => 0, 'data' => $result, 'errmsg' => 'ok'];
    } else {
        $res = json_decode($result, true);
        $res['data'] = '';
        return $res;
    }
}


/**
 * @param string $path æ–‡ä»¶å¤¹åœ°å€
 * @param string $file_name äºŒç»´ç å›¾ç‰‡åç§°
 * @param string $new_file_name åˆæˆåä¿å­˜çš„åœ°å€
 * @param int $new_width 
 */
function newImgQrCode($path, $file_name, $new_file_name, $new_width = 1125, $new_height = 2001)
{
    $haibao =  base_path('public/icon/haibao.png');
    $new_img_path = $path . $new_file_name;
    resize_image($haibao, $new_img_path, $new_width, $new_height);
    $QR = $path . $file_name;      //å·²ç»ç”Ÿæˆçš„åŸå§‹äºŒç»´ç å›¾
    $logo = $new_img_path; //ç”Ÿæˆçš„æ¨¡ç‰ˆå›¾
    if (file_exists($logo)) {
        $QR = imagecreatefromstring(file_get_contents($QR));    //ç›®æ ‡å›¾è±¡è¿æ¥èµ„æºã€‚
        $logo = imagecreatefromstring(file_get_contents($logo));  //æºå›¾è±¡è¿æ¥èµ„æºã€‚
        $QR_width = imagesx($QR);      //äºŒç»´ç å›¾ç‰‡å®½åº¦
        $QR_height = imagesy($QR);     //äºŒç»´ç å›¾ç‰‡é«˜åº¦
        $logo_width = imagesx($logo);    //logoå›¾ç‰‡å®½åº¦
        $logo_height = imagesy($logo);   //logoå›¾ç‰‡é«˜åº¦
        $logo_width = ($logo_width - $QR_width) + 100;
        $logo_height = ($logo_height - $QR_height) + 100;
        //é‡æ–°ç»„åˆå›¾ç‰‡å¹¶è°ƒæ•´å¤§å°
        /*
         * imagecopyresampled() å°†ä¸€å¹…å›¾åƒ(æºå›¾è±¡)ä¸­çš„ä¸€å—æ­£æ–¹å½¢åŒºåŸŸæ‹·è´åˆ°å¦ä¸€ä¸ªå›¾åƒä¸­
         * 520 1175
         */
        imagecopyresampled($logo, $QR, $logo_width, $logo_height, 0, 0, 250, 250, $QR_height, $QR_width);
        //è¾“å‡ºå›¾ç‰‡
        imagepng($logo, $new_img_path);
        imagedestroy($logo);
        imagedestroy($QR);
        //            echo '<img src="./img/qr_code.png" alt="ä½¿ç”¨å¾®ä¿¡æ‰«ææ”¯ä»˜">';die();

        return true;
    } else {
        return false;
    }
}
/**
 * æ”¹å˜å›¾ç‰‡çš„å®½é«˜
 *
 * @param string $img_src åŸå›¾ç‰‡çš„å­˜æ”¾åœ°å€æˆ–url
 * @param string $new_img_path æ–°å›¾ç‰‡çš„å­˜æ”¾åœ°å€
 * @param int $new_width æ–°å›¾ç‰‡çš„å®½åº¦
 * @param int $new_height æ–°å›¾ç‰‡çš„é«˜åº¦
 * @return bool  æˆåŠŸtrue, å¤±è´¥false
 * @author flynetcn (2009-12-16)
 *

 */

function resize_image($img_src, $new_img_path, $new_width, $new_height)
{

    $img_info = @getimagesize($img_src);
    if (!$img_info || $new_width < 1 || $new_height < 1 || empty($new_img_path)) {
        return false;
    }
    if (strpos($img_info['mime'], 'jpeg') !== false) {
        $pic_obj = imagecreatefromjpeg($img_src);
    } else if (strpos($img_info['mime'], 'gif') !== false) {
        $pic_obj = imagecreatefromgif($img_src);
    } else if (strpos($img_info['mime'], 'png') !== false) {
        $pic_obj = imagecreatefrompng($img_src);
    } else {
        return false;
    }
    $pic_width = imagesx($pic_obj);
    $pic_height = imagesy($pic_obj);
    if (function_exists("imagecopyresampled")) {
        $new_img = imagecreatetruecolor($new_width, $new_height);
        imagecopyresampled($new_img, $pic_obj, 0, 0, 0, 0, $new_width, $new_height, $pic_width, $pic_height);
    } else {
        $new_img = imagecreate($new_width, $new_height);
        imagecopyresized($new_img, $pic_obj, 0, 0, 0, 0, $new_width, $new_height, $pic_width, $pic_height);
    }
    if (preg_match('~.([^.]+)$~', $new_img_path, $match)) {
        $new_type = strtolower($match[1]);
        switch ($new_type) {
            case 'jpg':
                imagejpeg($new_img, $new_img_path);
                break;
            case 'gif':
                imagegif($new_img, $new_img_path);
                break;
            case 'png':
                imagepng($new_img, $new_img_path);
                break;
            default:
                imagejpeg($new_img, $new_img_path);
        }
    } else {
        imagejpeg($new_img, $new_img_path);
    }
    imagedestroy($pic_obj);
    imagedestroy($new_img);
    return true;
}
/**
 * @param int $type  0å°ç¨‹åº 1å…¬ä¼—å·
 */
function getAccessToken($type = 0)
{

    if ($type == 1) {
        $accessTokenObject = json_decode(file_get_contents('https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid=' . config('wx.gzh_AppId') . '&secret=' . config('wx.gzh_AppSecret')));
    } else {
        $accessTokenObject = json_decode(file_get_contents('https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid=' . config('wx.AppID') . '&secret=' . config('wx.AppSecret')));
    }
    if (!isset($accessTokenObject->access_token)) {
        success($accessTokenObject);
        error(errorCode()::GET_WX_ACCESS_TOKEN_NO, __('api.get_wx_access_token_no'));
    }
    $access_token = $accessTokenObject->access_token;
    return $access_token;
}




//------------------------------------------------å…¶ä»–------------------------------------

function getEthnic($key = -1)
{
    $arr = array('æ±‰æ—', 'å£®æ—', 'æ»¡æ—', 'å›æ—', 'ç»´å¾å°”æ—', 'è‹—æ—', 'åœŸå®¶æ—', 'å“ˆå°¼æ—', 'å“ˆè¨å…‹æ—', 'å…¶ä»–');
    if ($key > -1) {
        if (isset($arr[$key])) {
            return $arr[$key];
        } else {
            return $arr[9];
        }
    } else {
        return $arr;
    }
}
function getEducation($key = -1)
{
    $arr = array('å°å­¦', 'åˆä¸­', 'ä¸­ä¸“', 'é«˜ä¸­', 'å¤§ä¸“', 'æœ¬ç§‘', 'ç¡•å£«', 'åšå£«+');

    if ($key > -1) {
        if (isset($arr[$key])) {
            return $arr[$key];
        } else {
            return $arr[0];
        }
    } else {
        return $arr;
    }
}
function getEarnings($key = -1)
{
    $arr = array('2000å…ƒä»¥ä¸‹', '2000å…ƒ~3000å…ƒ', '3000å…ƒ~5000å…ƒ', '5000å…ƒ~8000å…ƒ', '8000å…ƒ~10000å…ƒ', '10000+');
    if ($key > -1) {
        if (isset($arr[$key])) {
            return $arr[$key];
        } else {
            return $arr[0];
        }
    } else {
        return $arr;
    }
}


/**
 * åŠ å¯†è§£å¯†
 * @param string $string éœ€è¦åŠ å¯†è§£å¯†çš„å­—ç¬¦ä¸²
 * @param bool $operation å¯†åŒ™
 * @param string $operation true åŠ å¯† falseè§£å¯†
 * @return string  
 */
function encryptStr($string,  $key = '', $operation = false)
{
    $key = md5($key);
    $key_length = strlen($key);
    $string = $operation  ? base64_decode($string) : substr(md5($string . $key), 0, 8) . $string;
    $string_length = strlen($string);
    $rndkey = $box = array();
    $result = '';
    for ($i = 0; $i <= 255; $i++) {
        $rndkey[$i] = ord($key[$i % $key_length]);
        $box[$i] = $i;
    }
    for ($j = $i = 0; $i < 256; $i++) {
        $j = ($j + $box[$i] + $rndkey[$i]) % 256;
        $tmp = $box[$i];
        $box[$i] = $box[$j];
        $box[$j] = $tmp;
    }
    for ($a = $j = $i = 0; $i < $string_length; $i++) {
        $a = ($a + 1) % 256;
        $j = ($j + $box[$a]) % 256;
        $tmp = $box[$a];
        $box[$a] = $box[$j];
        $box[$j] = $tmp;
        $result .= chr(ord($string[$i]) ^ ($box[($box[$a] + $box[$j]) % 256]));
    }
    if ($operation) {
        if (substr($result, 0, 8) == substr(md5(substr($result, 8) . $key), 0, 8)) {
            return substr($result, 8);
        } else {
            return '';
        }
    } else {
        return str_replace('=', '', base64_encode($result));
    }
}
//é©¼å³°å‘½åè½¬ä¸‹åˆ’çº¿å‘½å
function toUnderScore($str)
{
    $dstr = preg_replace_callback('/([A-Z]+)/', function ($matchs) {
        return '_' . strtolower($matchs[0]);
    }, $str);
    return trim(preg_replace('/_{2,}/', '_', $dstr), '_');
}
function logImg($key = 0)
{
    $value = [' ğŸ‘ ', 'à­§â¤âƒ', 'â¤', 'à­§', ' ğŸ„ ', ' ğŸ¥• '];
    if (!isset($value[$key])) return '';
    return $value[$key];
}
function logMyImg()
{
    return 'â¤ à­§â¤âƒ â¤';
}
/**
 * sqlå¯¼å…¥è¿‡æ»¤
 */
function sqlFiltration($v)
{
    $res = false;
    if (strstr($v, 'SET FOREIGN_KEY_CHECKS')) {
        $res = true;
    }
    if (strstr($v, '/*')) {
        $res = true;
    }
    if (strstr($v, 'DROP TABLE IF EXISTS')) {
        $res = true;
    }
    if (strstr($v, 'SET NAMES')) {
        $res = true;
    }
    if (strstr($v, 'CREATE TABLE')) {
        $res = true;
    }
    return $res;
}



function getCurl($url, $header = [])
{

    if (count($header) < 1) {
        $header = array(
            'Accept:application/json'
        );
    }
    $curl = curl_init();
    //è®¾ç½®æŠ“å–çš„url
    curl_setopt($curl, CURLOPT_URL, $url);
    //è®¾ç½®å¤´æ–‡ä»¶çš„ä¿¡æ¯ä½œä¸ºæ•°æ®æµè¾“å‡º
    curl_setopt($curl, CURLOPT_HEADER, 0);
    curl_setopt($curl, CURLOPT_CONNECTTIMEOUT, 360);
    // è¶…æ—¶è®¾ç½®,ä»¥ç§’ä¸ºå•ä½
    curl_setopt($curl, CURLOPT_TIMEOUT, 360);
    // è¶…æ—¶è®¾ç½®ï¼Œä»¥æ¯«ç§’ä¸ºå•ä½
    // curl_setopt($curl, CURLOPT_TIMEOUT_MS, 500);

    // è®¾ç½®è¯·æ±‚å¤´
    curl_setopt($curl, CURLOPT_HTTPHEADER, $header);
    //è®¾ç½®è·å–çš„ä¿¡æ¯ä»¥æ–‡ä»¶æµçš„å½¢å¼è¿”å›ï¼Œè€Œä¸æ˜¯ç›´æ¥è¾“å‡ºã€‚
    curl_setopt($curl, CURLOPT_RETURNTRANSFER, 1);
    curl_setopt($curl, CURLOPT_SSL_VERIFYPEER, false);
    curl_setopt($curl, CURLOPT_SSL_VERIFYHOST, false);
    //æ‰§è¡Œå‘½ä»¤
    $data = curl_exec($curl);

    // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
    $err = curl_error($curl);
    if ($err) {
        return [$err];
    } else {
        // æ‰“å°è¿”å›çš„å†…å®¹
        curl_close($curl);
        if (!empty($data) && $data) {
            $is_ex =   xml_parser($data);
            if (!$is_ex) {
                $data = json_decode($data, true);
            } else {
                $data = $is_ex;
            }
        } else {
            return [];
        }
        return $data;
    }
}
//è‡ªå®šä¹‰xmléªŒè¯å‡½æ•°xml_parser()
function xml_parser($str)
{
    $xml_parser = xml_parser_create();
    if (!xml_parse($xml_parser, $str, true)) {
        xml_parser_free($xml_parser);
        return false;
    } else {
        libxml_disable_entity_loader(true);
        $data = json_decode(json_encode(simplexml_load_string($str, 'SimpleXMLElement', LIBXML_NOCDATA), 320), true);
        return $data;
    }
}
function request_http($url, $data = null)
{
    $curl = curl_init();
    curl_setopt($curl, CURLOPT_URL, $url);
    curl_setopt($curl, CURLOPT_SSL_VERIFYPEER, false);
    curl_setopt($curl, CURLOPT_SSL_VERIFYHOST, false);
    if (!empty($data)) {
        curl_setopt($curl, CURLOPT_POST, true);
        curl_setopt($curl, CURLOPT_POSTFIELDS, $data);
    }
    curl_setopt($curl, CURLOPT_RETURNTRANSFER, 1);
    $res = curl_exec($curl);
    curl_close($curl);
    return $res;
}
/**
 * @param string $url è¯·æ±‚åœ°å€
 * @param array $data è¯·æ±‚å‚æ•° 
 * @param array $header è®¾ç½®å¤´éƒ¨å‚æ•°
 * @param bool $json  æ˜¯å¦å·²jsonæ ¼å¼å‘é€postè¯·æ±‚
 * @return string è¿”å›jsonå­—ç¬¦ä¸²
 */

function http($url, $data = [], $header = [], $json = true): string
{
    set_time_limit(0);
    $curl = curl_init();
    curl_setopt($curl, CURLOPT_URL, $url);
    if (!empty($header)) {
        curl_setopt($curl, CURLOPT_HTTPHEADER, $header);
    }
    curl_setopt($curl, CURLOPT_SSL_VERIFYPEER, false);
    curl_setopt($curl, CURLOPT_SSL_VERIFYHOST, false);
    curl_setopt($curl, CURLOPT_CONNECTTIMEOUT, 120);
    curl_setopt($curl, CURLOPT_POST, true);
    if (!empty($data)) {
        if ($json && is_array($data)) {
            $data = json_encode($data);
        }
        curl_setopt($curl, CURLOPT_POSTFIELDS, $data);
        if ($json) { //å‘é€JSONæ•°æ®
            curl_setopt($curl, CURLOPT_HEADER, 0);
            curl_setopt(
                $curl,
                CURLOPT_HTTPHEADER,
                array(
                    'Content-Type: application/json; charset=utf-8',
                    'Content-Length:' . strlen($data)
                )
            );
        }
    }
    curl_setopt($curl, CURLOPT_RETURNTRANSFER, 1);
    $res = curl_exec($curl);
    $errorno = curl_errno($curl);
    if ($errorno) {
        return false;
    }
    curl_close($curl);
    return $res;
}

function fromXml($xml)
{
    if (empty($xml)) {
        return '';
    }
    // ç¦æ­¢å¼•ç”¨å¤–éƒ¨xmlå®ä½“
    libxml_disable_entity_loader(true);
    $data = json_decode(json_encode(simplexml_load_string($xml, 'SimpleXMLElement', LIBXML_NOCDATA), 320), true);
    return $data;
}
function getNumber($model, $merchant_id = 0, $key = 'number', $i = 10000)
{
    $number  = $model->when($merchant_id > 0, function ($query) use ($merchant_id) {
        return $query->where('merchant_id', $merchant_id);
    })->max($key);
    if ($number) {
        $number++;
        return $number;
    } else {
        return $i;
    }
}

function getPwd($pwd = '888888')
{
    return md5(base64_encode($pwd));
}

function db_fix()
{
    $str = config('app.db_fix') ?? '';
    return $str;
}


/**
 * è°ƒè¯•
 */
function debugMessage($info = [], $msg = 'è°ƒè¯•æ•°æ®')
{
    Log::debug($msg, ['info' => $info]);
}

function unicodeDecode($unicode_str)
{
    $ison = '{"str":"' . $unicode_str . '"}';
    $arr = json_decode($ison, true);
    if (empty($arr)) return '';
    return $arr['str'];
}
/**
 * è·å–è·¯ç”±åç§°
 */
function routeName($name = '', $key = 'admin.v1.')
{
    $route_name = str_replace($key, "", $name);
    return $route_name;
}
/**
 * æ›²çº¿ç»“æ„
 * serieså­—æ®µç”Ÿæˆ
 */
function curveStructure($title = [], $list = []): array
{
    if (count($title) < 1 || count($list) < 1) {
        return array();
    }
    $series = array();
    foreach ($title as $k => $v) {
        $data = array();
        if (isset($list[$v['key']]) && count($list[$v['key']]) > 0) {
            $kes = array_values($list[$v['key']]);
            foreach ($kes as  $ks => $vs) {
                $data[] = $vs;
            }
        }
        $res = array('name' => $v['name'], 'data' => $data);
        if (isset($v['type']) && !empty($v['type'])) {
            $res['type'] = $v['type'];
        }
        $series[$k] = $res;
    }
    return $series;
}

/**
 * åœ†å½¢å›¾å’ŒæŸ±çŠ¶å›¾
 *
 */

function rawArtworkArr($key = [], $value = []): array
{
    if (count($key) > 0 && count($value) > 0) {
        $data = array();
        foreach ($key as $k => $v) {
            foreach ($value as $ks => $vs) {
                if (isset($vs[$k])) {
                    $data[$k][$ks] = $vs[$k];
                } else {
                    $data[$k][$ks] = 0;
                }
            }
        }
        return $data;
    } else {
        return [];
    }
}

function generateCode($id,$length = 4)
{
    $chars = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';
    $code = '';
    $base = 62; // æ€»å…±62ä¸ªå­—ç¬¦å¯ç”¨
    while ($id > 0) {
        $remainder = $id % $base;
        $code = $chars[$remainder] . $code;
        $id = floor($id / $base);
    }

    $paddedCode = str_pad($code, $length, '0', STR_PAD_LEFT);
    if (strlen($paddedCode) > $length) {
        $paddedCode = substr($paddedCode, -$length); // ä»æœ«å°¾æˆªå–æŒ‡å®šé•¿åº¦
    }

    return $paddedCode;
}


//-----------------------------------------------------æ—¶é—´ç›¸å…³---------------------------------------------

// è·å–13ä½æ¯«ç§’çº§æ—¶é—´æˆ³
function getMillisecond()
{
    list($t1, $t2) = explode(' ', microtime());
    $microtime = (float)sprintf('%.0f', (floatval($t1) + floatval($t2)) * 1000);
    $microtime = explode('.', $microtime);
    return $microtime[0];
}

function dayTime()
{
    $times = date('H:i:s', time());
    return $times;
}
function dayDateTime()
{
    $times = date('Y-m-d H:i:s', time());
    return $times;
}
function dayDate()
{
    $times = date('Y-m-d', time());
    return $times;
}
/**
 * æŒ‡å®šæ—¥æœŸåŠ Næœˆ é»˜è®¤å½“å‰æ—¶é—´åŠ 0
 * @param $date_time string Y-m-d
 * @param $number int 1
 */
function addMonth($date_time = '', $number = 0)
{
    return date('Y-m-d', strtotime($date_time . "+$number month"));
}
/**
 * æŒ‡å®šæ—¥æœŸåŠ Nå¤© é»˜è®¤å½“å‰æ—¶é—´åŠ 0
 * @param $date_time string Y-m-d
 * @param $number int 1
 */
function addDayDate($date_time = '', $number = 0)
{
    return date('Y-m-d', strtotime($date_time . "+$number day"));
}
/**
 * æŒ‡å®šæ—¥æœŸå‡Nå¤© é»˜è®¤å½“å‰æ—¶é—´åŠ 0
 * @param $date_time string Y-m-d
 * @param $number int 1
 */
function subtractDayDate($number = 0, $date_time = '')
{
    return date('Y-m-d', strtotime($date_time . "-$number day"));
}
//è·å–æŒ‡å®šæ—¶é—´æ˜¯æ˜ŸæœŸå‡ 
function getWeek($date)
{
    //å¼ºåˆ¶è½¬æ¢æ—¥æœŸæ ¼å¼
    $date_str = date('Y-m-d', strtotime($date));
    //å°è£…æˆæ•°ç»„
    $arr = explode("-", $date_str);
    //å‚æ•°èµ‹å€¼
    //å¹´
    $year = $arr[0];
    //æœˆï¼Œè¾“å‡º2ä½æ•´å‹ï¼Œä¸å¤Ÿ2ä½å³å¯¹é½
    $month = sprintf('%02d', $arr[1]);
    //æ—¥ï¼Œè¾“å‡º2ä½æ•´å‹ï¼Œä¸å¤Ÿ2ä½å³å¯¹é½
    $day = sprintf('%02d', $arr[2]);
    //æ—¶åˆ†ç§’é»˜è®¤èµ‹å€¼ä¸º0ï¼›
    $hour = $minute = $second = 0;
    //è½¬æ¢æˆæ—¶é—´æˆ³
    $strap = mktime($hour, $minute, $second, $month, $day, $year);
    //è·å–æ•°å­—å‹æ˜ŸæœŸå‡ 
    $number_wk = date("w", $strap);
    //è‡ªå®šä¹‰æ˜ŸæœŸæ•°ç»„
    // $weekArr = array("æ˜ŸæœŸæ—¥", "æ˜ŸæœŸä¸€", "æ˜ŸæœŸäºŒ", "æ˜ŸæœŸä¸‰", "æ˜ŸæœŸå››", "æ˜ŸæœŸäº”", "æ˜ŸæœŸå…­");
    //è·å–æ•°å­—å¯¹åº”çš„æ˜ŸæœŸ
    // return $weekArr[$number_wk];
    return $number_wk;
}
/** è®¡ç®—å¼€å§‹æ—¶é—´åˆ°ç»“æŸæ—¶é—´ä¹‹é—´é—´éš”å¤šå°‘å°æ—¶ */
function hoursDifference($date1, $date2)
{
    $timestamp1 = strtotime($date1);
    $timestamp2 = strtotime($date2);

    $diffInSeconds = $timestamp2 - $timestamp1;

    return (int)($diffInSeconds / 3600);  // è¿”å›æ•´æ•°å°æ—¶æ•°
}
/** å°æ—¶å‡å»åç”Ÿæˆç§’ */

function differenceInSeconds($hour1, $hour2)
{
    $hour1InSeconds = $hour1 * 60 * 60;
    $hour2InSeconds = $hour2 * 60 * 60;

    return round($hour1InSeconds - $hour2InSeconds);
}
/**
 * è®¡ç®—å¼€å§‹æ—¶é—´åˆ°ç»“æŸæ—¶é—´ä¹‹é—´çš„åˆ†é’Ÿæ•°
 */
function getBeginEndTime($begin_time = '', $end_time = ''): float
{
    $v_begin = strtotime($begin_time);
    $v_end = strtotime($end_time);
    $remain  = ($v_end - $v_begin) / 60;
    return $remain;
}

/**
 * å½“æ—¶é—´æ“åŠ Nå°æ—¶
 */
function getTimeAdd($n = 1)
{
    $times = time() + ((float)$n * 3600);
    return $times;
}


//ç¼“å­˜æ—¶é—´
function getCacheTime($v = 1): int
{
    return 60 * 60 * $v;
}

/**
 * è®¡ç®—å¼€å§‹æ—¶é—´åˆ°ç»“æŸæ—¶é—´çš„é—´éš”å¤©æ•°
 *
 * @param string $begin_time
 * @param string $end_time
 * @return void
 */
function getDateDay($begin_time = '', $end_time = ''): int
{
    $start_time = strtotime($begin_time);
    $end_time = strtotime($end_time);
    $count_days = (($end_time - $start_time) / 60 / 60 / 24);
    return (int)$count_days;
}
/**
 * è®¡ç®—å¼€å§‹æ—¶é—´åˆ°ç»“æŸæ—¶é—´çš„é—´éš”å¤©æ•°
 * float
 * @param string $begin_time
 * @param string $end_time
 * @return void
 */
function getDateDayTime($begin_time = '', $end_time = ''): int
{
    $start_time = strtotime($begin_time . ' 00:00:01');
    $end_time = strtotime($end_time . ' 23:59:59');
    $count_days = (($end_time - $start_time) / 60 / 60 / 24);
    return round($count_days, 0);
}
/**
 * è·å–æŒ‡å®šæœˆä»½æœ€åä¸€å¤©æ—¥æœŸ æ ¼å¼(2021-01-04)
 */
function getthemonth($date)
{
    $firstday = date('Y-m-01', strtotime($date));
    $lastday = date('Y-m-d', strtotime("$firstday +1 month -1 day"));
    return $lastday;
}
/**
 * è·å–æŒ‡å®šæ—¶é—´åŠ Nå¤©åçš„æ‰€æœ‰æ—¥æœŸ
 */
function getAddDateTime($begin_time, $number = 1)
{
    $end_time  = date('Y-m-d', strtotime($begin_time) + (86400 * $number) - 86400);
    return getDateFromRange($begin_time, $end_time);
}
/**
 * è·å–å¼€å§‹æ—¥æœŸåˆ°ç»“æŸæ—¥æœŸå†…çš„æ‰€æœ‰æ—¥æœŸ
 *
 * @param [type] $startdate
 * @param [type] $enddate
 * @return array
 */
function getDateFromRange(string $startdate, string $enddate, $desc = 'asc'): array
{
    $stimestamp = strtotime($startdate);
    $etimestamp = strtotime($enddate);

    // è®¡ç®—æ—¥æœŸæ®µå†…æœ‰å¤šå°‘å¤©
    $days = ($etimestamp - $stimestamp) / 86400 + 1;

    // ä¿å­˜æ¯å¤©æ—¥æœŸ
    $date = array();

    for ($i = 0; $i < $days; $i++) {
        $date[] = date('Y-m-d', $stimestamp + (86400 * $i));
    }
    if ($desc == 'desc') {
        rsort($data);
    } else {
        sort($date);
    }
    return $date;
}

/**
 * æ ¼å¼åŒ–å¯¼å…¥çš„æ—¶é—´æ“
 */
function fromttingDate($time)
{
    if (is_int($time) || is_float($time)) {
        return ($time - 25569) * 24 * 3600;
    } else {
        return strtotime($time);
    }
}
/**
 * è·å–å½“å¤©æ—¶æ®µ
 */
function getFourTime($k = 1, $v = -1): array
{
    $data = array();
    for ($i = 0; $i <= 24; $i++) {
        if ($i % $k == 0 && $i != $v) {
            if ($i < 10) {
                $data[] = '0' . $i;
            } else {
                $data[] = $i;
            }
        }
    }
    return $data;
}
/**
 * è·å–æŒ‡å®šæ—¥æœŸçš„å‘¨ä¸€ æ—¥æœŸ
 * @param $monday string 2021-07-21
 */
function getWeekMonday($monday)
{
    $monday  = strtotime($monday);
    $times = date('Y-m-d', ($monday - ((date('w', $monday) == 0 ? 7 : date('w', $monday)) - 1) * 24 * 3600));
    return $times;
}
/**
 * è·å–æŒ‡å®šæ—¥æœŸçš„å‘¨æ—¥ æ—¥æœŸ
 * @param $monday string 2021-07-21
 */

function getWeekEnd($monday)
{
    $monday = strtotime($monday);
    //0 6 5 4 3 2 1 
    $day = date('w', $monday);
    if ($day == 0) {
        $time  =  date('Y-m-d', $monday);
    } elseif ($day == 6) {
        $time = date('Y-m-d', $monday + (24 * 3600));
    } else {
        $time = date('Y-m-d', $monday + ((7 - $day) * 24 * 3600));
    }
    return $time;
}

//-----------------------------------------------sqlè¯­å¥ç›¸å…³------------------------------------------
/**
 * ç”Ÿæˆæ‰¹é‡æ›´æ–°sqlè¯­å¥ æ›´æ–°å¤šä¸ªå­—æ®µç»†åˆ†ä¸ºä¸åŒå€¼
 * @param array $key éœ€è¦ä¿®æ”¹çš„å­—æ®µ
 * @param array $param ä¿®æ”¹çš„æ•°æ®(2ç»´æ•°ç»„)
 * @param int $x æ•°æ®åº“è¡¨ä¸‹æ ‡
 * @param string $id éœ€è¦æŒ‡å®šä¿®æ”¹çš„æ¡ä»¶å­—æ®µé»˜è®¤idä¸»é”®
 * @return string
 */
function updateAll($key = [], $param = [], $table = '', $id = 'id', $x = 0)
{
    $where_in_ids = implode(',', array_map(function ($v) use ($id) {
        return $v[$id];
    }, $param));

    $sql = 'UPDATE `' . $table . '` SET';
    $i = 0;
    foreach ($key as $k => $v) {
        $i++;
        if ($i == 1) {
            $sql .= " `$v` = CASE $id ";
            $str = '';
        } else {
            $sql .= " END, `$v` = CASE $id ";
            $str = '';
        }
        foreach ($param as $ky => $vo) {
            if (isset($vo[$id]) && $vo[$v]) {
                $str .= " WHEN $vo[$id] THEN '$vo[$v]' ";
            } else {
                $str .= " WHEN $vo[$id] THEN 0 ";
            }
        }
        $sql .= $str;
    }
    $sql .= " END WHERE `$id` IN ($where_in_ids) ";
    return $sql;
}

//----------------------------------------------------------éšæœºæ–¹æ³•---------------------------------------------------
//è·å–éšæœºå­—ç¬¦ä¸²
function randomStr($len = 6)
{
    $arr = array('q', 'w', 'e', 'r', 't', 'y', 'u', 'i', 'o', 'p', 'a', 'z', 'x', 'c', 'v', 'b', 'n', 'm', 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 'Q', 'W', 'E', 'R', 'T', 'Y', 'U', 'I', 'O', 'P', 'A', 'S', 'D', 'F', 'G', 'H', 'J', 'K', 'L', 'Z', 'X', 'C', 'V', 'B', 'N', 'M');
    $str = '';
    for ($i = 1; $i <= $len; $i++) {
        $key = rand(0, 53);
        $str .= $arr[$key];
    }
    return $str;
}
/**
 * éšæœº6ä½æ•°int
 */
function getUniqueIntCode($model, $key = 'machine_code', $str = '', $i = 0)
{
    if ($i > 6) {
        return  rand(100000, 999999);
    }
    $i++;
    if (!empty($str)) {
        $res =  $model->where($key, $str)->exists();
        if (!$res) {
            return $str;
        } else {
            return getUniqueIntCode($model, $key, $str, $i);
        }
    } else {
        $str_rand = rand(100000, 999999);
        return getUniqueIntCode($model, $key, $str_rand, $i);
    }
}
/**
 * éšæœºå­—ç¬¦ä¸²
 */
function getUniqueStrCode($model, $key = 'machine_code', $len = 6, $str = '', $i = 0)
{
    if ($i > 6) {
        return '';
    }
    $i++;
    if (!empty($str)) {
        $res =  $model->where($key, $str)->exists();
        if (!$res) {
            return $str;
        } else {
            return getUniqueStrCode($model, $key, $len, $str, $i);
        }
    } else {
        $str = randomStr($len);
        return getUniqueStrCode($model, $key, $len, $str, $i);
    }
}
/**
 * ç”Ÿæˆ26ä½å”¯ä¸€è®¢å•å·
 * @param object $model  æ•°æ®åº“ç±»
 * @param string $user_id  å‰ç¼€
 * @param string $order_key  é»˜è®¤å­—æ®µkey
 * @param array $where  æ¡ä»¶
 * @param int $i  å¾ªç¯æ¬¡æ•°
 * @param int $len  è®¢å•å·é•¿åº¦
 * @return string
 */
function orderSn($user_id = "0", $order_key = 'order',  $where = [], $i = 0, $len = 10)
{
    $order_sn = $user_id;
    if (strlen($user_id) < $len) {
        $len = (int)($len - strlen($user_id));
        for ($i = 1; $i <= $len; $i++) {
            $order_sn .= rand(0, 9);
        }
    }
    // $where = array_merge([[$order_key, '=', $order_sn]], $where);
    // $res =  $model->where($where)->exists();
    $res = Cache::get($order_sn, false);
    if ($res && $res == $order_key) {
        $i++;
        if ($i < 4) {
            return orderSn($user_id, $order_key, $where, $i, $len);
        } else {
            $order_sn  = time() + (rand(1000, 9999));
            Cache::put($order_sn, $order_key);
            return $order_sn;
        }
    }
    //return $prefix . $user_id . time() . substr(microtime(), 2, 6) . sprintf('%03d', rand(0, 999));//32ä½
    // return $user_id . time(); //18ä½
    return $order_sn;
}
/**
 * éšæœºå•å·
 */
function orderStrSn($user_id = 0, $len = 10)
{
    $order_sn = $user_id;
    if (strlen($user_id) < $len) {
        $len = (int)($len - strlen($user_id));
        for ($i = 1; $i <= $len; $i++) {
            $order_sn .= rand(0, 9);
        }
    }
    return $order_sn;
}
//ç”ŸæˆæŒ‡å®šçš„å­—ç¬¦ä¸²é•¿åº¦
function generateUniqueString($length = 4)
{
    if ($length < 4) {
        $length = 4;
    }
    $characters = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';
    $charLength = strlen($characters);
    $uniqueString = '';
    for ($i = 0; $i < $length; $i++) {
        if ($i == 0) {
            $uniqueString .= $characters[rand(10, 35)];
        } elseif ($i == 1) {
            $uniqueString .= $characters[rand(0, 9)];
        } elseif ($i == 2 || $i == 3) {
            $uniqueString .= $characters[rand(0, $charLength - 1)];
        } else {
            $uniqueString .= $characters[rand(10, $charLength - 1)];
        }
    }
    return $uniqueString;
}

//----------------------------------------------------------æ•°æ®åº“è¿ç§»---------------------------------------------------

//----------------------------------------------------------redisç›¸å…³----------------------------------------------------

/**
 * redis æ¶ˆæ¯å…¥é˜Ÿ
 */
function redisRpush($info, $key = 'default', $time = 60)
{

    $i = 1;
    while ($info['number'] >= $i) {
        $i++;
        Redis::rpush($key, $info['price']);
    }
    Redis::expire($key, $time);
}
function redisLpop($key)
{
    return  Redis::lpop($key);
}
function redisRpushUnit($redis_value, $key = 'default')
{
    return  Redis::rpush($key, $redis_value);
}
/**
 * redis é¢‘ç‡è¯·æ±‚é™åˆ¶
 */
function redisFrequency(string $key = 'default',  $redis_value = "", int $time = 10)
{
    $get_value = Redis::get($key);
    if ($get_value) {
        return $get_value;
    } else {
        Redis::setex($key, $redis_value, $time);
        return false;
    }
}
/**
 * è·å–é˜Ÿåˆ—é•¿åº¦
 */
function redisLlen(string $key = '')
{
    return Redis::llen($key);
}
//----------------------------------------------------------è·ç¦»è®¡ç®—----------------------------------------------------
/** è·å–ç”¨æˆ·æœ€è¿‘çš„åº—é“º
 * @param $shopList
 * @param $lon
 * @param $lat
 * @return array
 */
function nearestShop($shopList, $lon, $lat)
{
    $arr = [];
    foreach ($shopList as $key => $shop) {
        $arr[$key] = getDistance($lon, $lat, $shop['longitude'], $shop['latitude']);
    }
    asort($arr);    //æŒ‰è·ç¦»æ’åº
    return $shopList[array_keys($arr)[0]];
}

/** æ ¹æ®åæ ‡è®¡ç®—è·ç¦»
 * @param float $lon1
 * @param float $lat1
 * @param float $lon2
 * @param float $lat2
 * @param int $unit å•ä½ 2æ˜¯å…¬é‡Œ
 * @param int $decimal å››èˆäº”å…¥å°æ•°ç‚¹åä½æ•°
 * @return float
 */
function getDistance($lon1, $lat1, $lon2, $lat2, $unit = 2, $decimal = 2)
{
    $EARTH_RADIUS = 6371; // åœ°çƒåŠå¾„ç³»æ•°

    //å°†è§’åº¦è½¬ä¸ºç‹åº¦
    $radLng1 = deg2rad($lon1);
    $radLat2 = deg2rad($lat2);
    $radLat1 = deg2rad($lat1);
    $radLng2 = deg2rad($lon2);

    $distance = 2 * asin(sqrt(pow(sin(($radLat1 - $radLat2) / 2), 2) + cos($radLat1) * cos($radLat2) * pow(sin(($radLng1 - $radLng2) / 2), 2))) * $EARTH_RADIUS * 1000;

    if ($unit === 2) {
        $distance /= 1000;
    }
    return round($distance, $decimal);
}
//----------------------------------------------------------æ•°æ®åº“è¿ç§»---------------------------------------------------

/**
 * è®¾ç½®æ•°æ®è¡¨å­—æ®µå±æ€§
 * @param  string $type å­—æ®µå±æ€§
 * @param string $comment æè¿°
 * @param string $default é»˜è®¤å€¼
 * @param string $leng é•¿åº¦
 */
function setTableKey($type = 'string', $comment = '', $default = '', $leng = 120): array
{
    return array(
        'type' => $type,
        'comment' => $comment,
        'default' => $default,
        'leng' => $leng
    );
}

function setTableForm($table_name, $data, $up = false)
{
    if (count($data) > 0) {
        foreach ($data as $k => $v) {
            if ($up == true && Schema::hasColumn($table_name, $k)) {
                if ($v['type'] == 'string' || $v['type'] == 'char') {
                    Schema::table($table_name, function (Blueprint $table) use ($k, $v) {
                        $type = $v['type'];
                        $table->$type($k, $v['leng'])->default($v['default'])->change();
                    });
                } elseif ($v['type'] == 'text' || $v['type'] == 'longText'  || $v['type'] == 'json') {
                    Schema::table($table_name, function (Blueprint $table) use ($k, $v) {
                        $type = $v['type'];
                        $table->$type($k)->nullable()->change();
                    });
                } else {
                    Schema::table($table_name, function (Blueprint $table) use ($k, $v) {
                        $type = $v['type'];
                        $table->$type($k)->default($v['default'])->change();
                    });
                }
            }

            if (!Schema::hasColumn($table_name, $k)) {

                if ($v['type'] == 'string' || $v['type'] == 'char') {
                    Schema::table($table_name, function (Blueprint $table) use ($k, $v) {
                        $type = $v['type'];
                        $table->$type($k, $v['leng'])->default($v['default'])->comment($v['comment']);
                    });
                } elseif ($v['type'] == 'timestamp' || $v['type'] == 'text' || $v['type'] == 'longText' || $v['type'] == 'json') {
                    Schema::table($table_name, function (Blueprint $table) use ($k, $v) {
                        $type = $v['type'];
                        $table->$type($k)->nullable()->comment($v['comment']);
                    });
                } else {
                    Schema::table($table_name, function (Blueprint $table) use ($k, $v) {
                        $type = $v['type'];
                        $table->$type($k)->default($v['default'])->comment($v['comment']);
                    });
                }
            }
        }
    }
}
